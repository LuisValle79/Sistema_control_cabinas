<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Usuarios - CyberCafé</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- SweetAlert2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <!-- Font Awesome para íconos -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Estilos para las estadísticas */
        .rental-stats {
            background-color: var(--white);
            border-radius: var(--border-radius-md);
            padding: 1.25rem;
            box-shadow: var(--shadow-sm);
            transition: var(--transition-normal);
        }
        
        .rental-stats:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-3px);
        }
        
        .rental-stats .icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-normal);
        }
        
        .rental-stats .icon i {
            font-size: 1.5rem;
            transition: var(--transition-normal);
        }
        
        .rental-stats:hover .icon {
            transform: scale(1.1);
        }
        
        .rental-stats h3 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            color: var(--text-color);
        }
        
        .rental-stats .badge {
            font-weight: 500;
            font-size: 0.8rem;
        }
        
        .rounded-pill {
            border-radius: 50rem;
        }
        
        /* Estilos para las tarjetas de máquinas */
        .machine-card {
            transition: var(--transition-normal);
            border: none;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }
        
        .machine-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }
        
        .machine-card .card-header {
            border-radius: var(--border-radius-md) var(--border-radius-md) 0 0 !important;
            background: var(--card-header-gradient);
            color: var(--white);
            padding: 1rem 1.25rem;
        }
        
        .machine-card .card-header .badge {
            padding: 0.5rem 0.75rem;
            font-weight: 600;
            font-size: 0.85rem;
            border-radius: 50rem;
        }
        
        .machine-card .card-body {
            padding: 1.25rem;
        }
        
        .machine-card .card-footer {
            background-color: rgba(0,0,0,0.02);
            padding: 1rem 1.25rem;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="d-flex" id="wrapper">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar-wrapper">
            <div class="logo">
                <img src="assets/logocabinas.jpg" alt="Logo" />
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Principal</div>
                <a href="pagina1.html" class="nav-link">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="machines.html" class="nav-link">
                    <i class="fas fa-desktop"></i>
                    <span>Cabinas</span>
                </a>
                <a href="rentals.html" class="nav-link">
                    <i class="fas fa-clock"></i>
                    <span>Alquileres</span>
                </a>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Administración</div>
                <a href="users.html" class="nav-link active">
                    <i class="fas fa-users"></i>
                    <span>Usuarios</span>
                </a>
                <a href="reports.html" class="nav-link">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reportes</span>
                </a>
                <a href="settings.html" class="nav-link">
                    <i class="fas fa-cog"></i>
                    <span>Configuración</span>
                </a>
            </div>
             
            <div class="nav-section">
                <div class="nav-section-title">Cuenta</div>
                <a href="#" class="nav-link" id="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Cerrar Sesión</span>
                </a>
            </div>
             
            <div class="user-info">
                <div class="user-avatar">A</div>
                <div class="user-details">
                    <div class="user-name">Admin</div>
                    <div class="user-role">Administrador</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-light" id="navbar">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1 d-flex align-items-center">
                <i class="fas fa-bars toggle-btn me-3" id="toggle-btn"></i>
                Gestión de Usuarios - CyberCafé
            </span>
            <div>
                <button class="btn btn-primary" onclick="openCreateUserModal()"><i class="fas fa-plus me-2"></i>Agregar Usuario</button>
            </div>
        </div>
    </nav>

    <!-- Contenido Principal -->
    <div class="content" id="content">
        <div class="container">
            <div class="table-container">
                <h4 class="mb-4">Lista de Usuarios</h4>
                <ul class="nav nav-tabs mb-4">
                    <li class="nav-item">
                        <a class="nav-link active" href="#active-users" data-bs-toggle="tab" onclick="loadUserTable(true)">Usuarios Activos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#inactive-users" data-bs-toggle="tab" onclick="loadUserTable(false)">Usuarios Inactivos</a>
                    </li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="active-users">
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Nombre</th>
                                        <th>Email</th>
                                        <th>Teléfono</th>
                                        <th>Rol</th>
                                        <th>Fecha Registro</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="active-users-table">
                                    <!-- Filas generadas dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="inactive-users">
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Nombre</th>
                                        <th>Email</th>
                                        <th>Teléfono</th>
                                        <th>Rol</th>
                                        <th>Fecha Registro</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="inactive-users-table">
                                    <!-- Filas generadas dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Crear/Editar Usuario -->
    <div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalLabel">Agregar Usuario</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <input type="hidden" id="userId">
                        <div class="mb-3">
                            <label for="userName" class="form-label">Nombre Completo (Usuario)</label>
                            <input type="text" class="form-control" id="userName" required>
                        </div>
                        <div class="mb-3">
                            <label for="userEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="userEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="userPhone" class="form-label">Teléfono</label>
                            <input type="tel" class="form-control" id="userPhone" required>
                        </div>
                        <div class="mb-3">
                            <label for="userRole" class="form-label">Rol</label>
                            <select class="form-select" id="userRole" required>
                                <option value="Cliente">Cliente</option>
                                <option value="Administrador">Administrador</option>
                                <option value="Empleado">Empleado</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="userPassword" class="form-label">Contraseña</label>
                            <input type="password" class="form-control" id="userPassword" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveUser()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // Inicializar el cliente Supabase
    const { createClient } = window.supabase;
    const supabaseUrl = 'https://jbirpporhcxssduqwvge.supabase.co'; // Tu Project URL
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpiaXJwcG9yaGN4c3NkdXF3dmdlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxNzYzNTEsImV4cCI6MjA2ODc1MjM1MX0.5rvXuuYdA95MsRAtpfiT-7R8SxdHh0sOm4ZsxvjeMUg'; // Tu anon key
    const supabase = createClient(supabaseUrl, supabaseAnonKey);

    // Función de depuración
    function log(message) {
        console.log(`[${new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}] ${message}`);
    }

    // Función para mostrar alertas
    function showAlert(title, message, type, options = {}) {
        return Swal.fire({
            title: title,
            text: message,
            icon: type,
            confirmButtonText: 'Aceptar',
            ...options,
            buttonsStyling: false,
            customClass: {
                confirmButton: 'btn btn-primary',
                popup: 'animated fadeIn'
            }
        });
    }

    // Inicializar la página con autenticación
    async function initUsersPage() {
        const { data: { session }, error } = await supabase.auth.getSession();
        if (error || !session) {
            log('No hay sesión activa: ' + (error ? error.message : 'Sin sesión'));
            showAlert('Sesión expirada', 'Debes iniciar sesión como administrador.', 'warning').then(() => {
                window.location.href = 'index.html';
            });
            return;
        }
        log(`Sesión activa. User ID: ${session.user.id}`);

        // Cargar tablas de usuarios
        loadUserTable(true); // Usuarios activos
        loadUserTable(false); // Usuarios inactivos o eliminados

        // Configurar toggle del sidebar
        const toggleBtn = document.getElementById('toggle-btn');
        if (toggleBtn) {
            toggleBtn.addEventListener('click', toggleSidebar);
        }

        // Configurar formulario del modal
        const userForm = document.getElementById('userForm');
        if (userForm) {
            userForm.addEventListener('submit', function(e) {
                e.preventDefault();
                saveUser();
            });
        }
    }

    // Función para cerrar sesión
    async function logout() {
        log('Cerrando sesión...');
        const { error } = await supabase.auth.signOut();
        if (error) {
            log(`Error al cerrar sesión: ${error.message}`);
            showAlert('Error', 'No se pudo cerrar la sesión.', 'error');
        } else {
            log('Sesión cerrada exitosamente.');
            showAlert('Éxito', 'Sesión cerrada.', 'success').then(() => {
                window.location.href = 'index.html';
            });
        }
    }

    // Función para cargar la tabla de usuarios
    async function loadUserTable(active) {
        log(`Cargando tabla de usuarios ${active ? 'activos' : 'inactivos'}...`);
        const { data, error } = await supabase
            .from('users')
            .select('*')
            .eq('is_active', active);
        if (error) {
            log(`Error al cargar usuarios: ${error.message}`);
            showAlert('Error', 'No se pudieron cargar los usuarios.', 'error');
        } else {
            const tbody = document.getElementById(active ? 'active-users-table' : 'inactive-users-table');
            tbody.innerHTML = '';
            data.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.name || 'N/A'}</td>
                    <td>${user.email}</td>
                    <td>${user.phone || 'N/A'}</td>
                    <td>${user.role}</td>
                    <td>${new Date(user.created_at).toLocaleDateString()}</td>
                    <td>
                        ${active ? `
                            <button class="btn btn-sm btn-warning" onclick="openEditUserModal('${user.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.id}')"><i class="fas fa-trash"></i></button>
                        ` : `
                            <button class="btn btn-sm btn-success" onclick="restoreUser('${user.id}')"><i class="fas fa-undo"></i></button>
                        `}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
    }

    // Función para abrir el modal de crear/editar usuario
    function openCreateUserModal() {
        log('Abriendo modal para crear usuario...');
        document.getElementById('userId').value = '';
        document.getElementById('userName').value = '';
        document.getElementById('userEmail').value = '';
        document.getElementById('userPhone').value = '';
        document.getElementById('userRole').value = 'Cliente';
        document.getElementById('userPassword').value = '';
        document.getElementById('userModalLabel').textContent = 'Agregar Usuario';
        new bootstrap.Modal(document.getElementById('userModal')).show();
    }

    // Función para abrir el modal de edición
    function openEditUserModal(userId) {
        log(`Abriendo modal para editar usuario con ID: ${userId}...`);
        supabase
            .from('users')
            .select('*')
            .eq('id', userId)
            .single()
            .then(({ data, error }) => {
                if (error) {
                    log(`Error al cargar usuario: ${error.message}`);
                    showAlert('Error', 'No se pudo cargar el usuario.', 'error');
                } else {
                    document.getElementById('userId').value = data.id;
                    document.getElementById('userName').value = data.name || '';
                    document.getElementById('userEmail').value = data.email;
                    document.getElementById('userPhone').value = data.phone || '';
                    document.getElementById('userRole').value = data.role;
                    document.getElementById('userPassword').value = ''; // No mostrar contraseña por seguridad
                    document.getElementById('userModalLabel').textContent = 'Editar Usuario';
                    new bootstrap.Modal(document.getElementById('userModal')).show();
                }
            });
    }

    // Función para guardar usuario
    async function saveUser() {
        log('Guardando usuario...');
        const userId = document.getElementById('userId').value;
        const userData = {
            name: document.getElementById('userName').value,
            email: document.getElementById('userEmail').value,
            phone: document.getElementById('userPhone').value,
            role: document.getElementById('userRole').value,
            is_active: true
        };
        const password = document.getElementById('userPassword').value;

        try {
            if (userId) {
                // Actualizar usuario existente
                const { error } = await supabase
                    .from('users')
                    .update(userData)
                    .eq('id', userId);
                if (error) throw error;
                log(`Usuario con ID ${userId} actualizado`);
                showAlert('Éxito', 'Usuario actualizado exitosamente.', 'success').then(() => {
                    document.getElementById('userModal').querySelector('[data-bs-dismiss="modal"]').click();
                    loadUserTable(true);
                    loadUserTable(false);
                });
            } else {
                // Crear nuevo usuario
                if (!password) {
                    throw new Error('La contraseña no puede estar vacía.');
                }
                log(`Intentando registrar usuario con email: ${userData.email}`);
                const { data, error: authError } = await supabase.auth.signUp({
                    email: userData.email,
                    password: password,
                    options: {
                        data: { role: userData.role }
                    }
                });
                if (authError) {
                    log(`Error en auth.signUp: ${authError.message}`);
                    throw authError;
                }
                log(`Usuario creado en auth con ID: ${data.user.id}`);
                const { error: insertError } = await supabase
                    .from('users')
                    .insert({
                        id: data.user.id,
                        name: userData.name,
                        email: userData.email,
                        phone: userData.phone,
                        role: userData.role,
                        is_active: userData.is_active,
                        created_at: new Date().toISOString()
                    });
                if (insertError) {
                    log(`Error en inserción a public.users: ${insertError.message}`);
                    throw insertError;
                }
                log(`Usuario con ID ${data.user.id} creado en public.users`);
                showAlert('Éxito', 'Usuario creado exitosamente. Revisa tu email para confirmarlo.', 'success').then(() => {
                    document.getElementById('userModal').querySelector('[data-bs-dismiss="modal"]').click();
                    loadUserTable(true);
                    loadUserTable(false);
                });
            }
        } catch (error) {
            log(`Error al guardar usuario: ${error.message}`);
            showAlert('Error', `No se pudo ${userId ? 'actualizar' : 'crear'} el usuario: ${error.message}`, 'error');
        }
    }

    // Función para eliminar usuario
    async function deleteUser(userId) {
        log(`Eliminando usuario con ID: ${userId}...`);
        showAlert('Confirmar', '¿Estás seguro de eliminar este usuario?', 'warning', {
            showCancelButton: true,
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                supabase
                    .from('users')
                    .update({ is_active: false })
                    .eq('id', userId)
                    .then(({ error }) => {
                        if (error) {
                            log(`Error al eliminar usuario: ${error.message}`);
                            showAlert('Error', 'No se pudo eliminar el usuario.', 'error');
                        } else {
                            log(`Usuario con ID ${userId} eliminado`);
                            showAlert('Éxito', 'Usuario eliminado exitosamente.', 'success').then(() => {
                                loadUserTable(true);
                                loadUserTable(false);
                            });
                        }
                    });
            }
        });
    }

    // Función para restaurar usuario
    async function restoreUser(userId) {
        log(`Restaurando usuario con ID: ${userId}...`);
        showAlert('Confirmar', '¿Estás seguro de restaurar este usuario?', 'info', {
            showCancelButton: true,
            confirmButtonText: 'Sí, restaurar',
            cancelButtonText: 'Cancelar',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                supabase
                    .from('users')
                    .update({ is_active: true })
                    .eq('id', userId)
                    .then(({ error }) => {
                        if (error) {
                            log(`Error al restaurar usuario: ${error.message}`);
                            showAlert('Error', 'No se pudo restaurar el usuario.', 'error');
                        } else {
                            log(`Usuario con ID ${userId} restaurado`);
                            showAlert('Éxito', 'Usuario restaurado exitosamente.', 'success').then(() => {
                                loadUserTable(true);
                                loadUserTable(false);
                            });
                        }
                    });
            }
        });
    }

    // Función para alternar el sidebar
    function toggleSidebar() {
        log('Alternando sidebar...');
        document.getElementById('sidebar-wrapper').classList.toggle('toggled');
        document.getElementById('content').classList.toggle('toggled');
    }

    // Inicializar al cargar la página
    document.addEventListener('DOMContentLoaded', () => {
        initUsersPage();
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                logout();
            });
        }
    });
</script>
</body>
</html>